---
apiVersion: v1
kind: Namespace
metadata:
  name: cert-status-app
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cert-app-content-pvc
  namespace: cert-status-app
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: kubevirt-csi-infra-default
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-monitor-sa
  namespace: cert-status-app
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-monitor-role
rules:
- apiGroups: [""]
  resources: ["secrets", "namespaces"]
  verbs: ["get", "list"]
- apiGroups: ["certificates.k8s.io"]
  resources: ["certificatesigningrequests"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-monitor-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-monitor-role
subjects:
- kind: ServiceAccount
  name: cert-monitor-sa
  namespace: cert-status-app
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cert-checker-script-corrected
  namespace: cert-status-app
data:
  check-certs.sh: |
    #!/bin/bash
    # OpenShift Certificate Monitor - Corrected Rotation Logic
    # Certificates are rotated at 80% of their actual lifespan based on expiry date
    
    OUTPUT_FILE="/var/www/html/certs.html"
    
    # Function to calculate rotation time at 80% of certificate lifespan
    calculate_rotation_at_80_percent() {
        local not_before="$1"
        local not_after="$2"
        
        if [ -z "$not_before" ] || [ -z "$not_after" ]; then
            echo "Unknown"
            return
        fi
        
        # Convert dates to epoch
        local before_epoch=$(date -d "$not_before" +%s 2>/dev/null)
        local after_epoch=$(date -d "$not_after" +%s 2>/dev/null)
        local current_epoch=$(date +%s)
        
        if [ -z "$before_epoch" ] || [ -z "$after_epoch" ]; then
            echo "Parse error"
            return
        fi
        
        # Calculate total certificate lifespan in seconds
        local total_lifespan=$((after_epoch - before_epoch))
        
        # Calculate 80% of lifespan
        local rotation_lifespan=$((total_lifespan * 80 / 100))
        
        # Calculate rotation time (creation + 80% of lifespan)
        local rotation_epoch=$((before_epoch + rotation_lifespan))
        
        # Calculate days until rotation
        local days_until_rotation=$(( (rotation_epoch - current_epoch) / 86400 ))
        
        # If rotation time has passed, certificate should have been rotated already
        if [ $rotation_epoch -le $current_epoch ]; then
            echo "Should have rotated (overdue)"
        else
            local rotation_date=$(date -d "@$rotation_epoch" "+%m/%d/%Y")
            echo "$rotation_date (~${days_until_rotation} days)"
        fi
    }

    # Function to get certificate info and convert to HTML
    generate_html_output() {
        # Capture metadata values
        GENERATED_TIME=$(date)
        CLUSTER_NAME=$(oc whoami --show-server 2>/dev/null | sed 's/https:\/\///' | cut -d':' -f1 2>/dev/null || echo 'my-hosted-cluster')
        USER_NAME=$(oc whoami 2>/dev/null || echo 'system:serviceaccount')
        
        cat > "$OUTPUT_FILE" << EOF
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OpenShift Certificate Monitor</title>
        <meta http-equiv="refresh" content="1200">
        <style>
            /* OpenShift Console-inspired color scheme and design */
            :root {
                --pf-global--Color--100: #151515;
                --pf-global--Color--200: #6a6e73;
                --pf-global--Color--300: #4f5255;
                --pf-global--primary-color--100: #0066cc;
                --pf-global--primary-color--200: #004080;
                --pf-global--success-color--100: #3e8635;
                --pf-global--success-color--200: #2d5016;
                --pf-global--warning-color--100: #f0ab00;
                --pf-global--warning-color--200: #c58c00;
                --pf-global--danger-color--100: #c9190b;
                --pf-global--danger-color--200: #a30000;
                --pf-global--BackgroundColor--100: #ffffff;
                --pf-global--BackgroundColor--200: #f5f5f5;
                --pf-global--BackgroundColor--300: #ededed;
                --pf-global--BorderColor--100: #d2d2d2;
                --pf-global--BorderColor--200: #8a8d90;
                --pf-global--box-shadow: 0 0.25rem 0.5rem 0rem rgba(3, 3, 4, 0.12), 0 0 0.25rem 0rem rgba(3, 3, 4, 0.06);
            }
            
            * {
                box-sizing: border-box;
            }
            
            body {
                font-family: "RedHatText", "Overpass", overpass, helvetica, arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: var(--pf-global--BackgroundColor--200);
                color: var(--pf-global--Color--100);
                line-height: 1.5;
                font-size: 14px;
            }
            
            .page-header {
                background-color: var(--pf-global--BackgroundColor--100);
                border-bottom: 1px solid var(--pf-global--BorderColor--100);
                padding: 1rem 2rem;
                margin-bottom: 2rem;
                box-shadow: var(--pf-global--box-shadow);
            }
            
            .page-title {
                color: var(--pf-global--Color--100);
                font-size: 2rem;
                font-weight: 500;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .page-subtitle {
                color: var(--pf-global--Color--200);
                font-size: 1rem;
                margin: 0.5rem 0 0 0;
                font-weight: 400;
            }
            
            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 2rem 2rem;
            }
            
            .breadcrumb {
                background-color: var(--pf-global--BackgroundColor--100);
                padding: 0.75rem 2rem;
                border-bottom: 1px solid var(--pf-global--BorderColor--100);
                font-size: 14px;
            }
            
            .breadcrumb a {
                color: var(--pf-global--primary-color--100);
                text-decoration: none;
            }
            
            .breadcrumb a:hover {
                text-decoration: underline;
            }
            
            .tabs {
                display: flex;
                background-color: var(--pf-global--BackgroundColor--100);
                border-bottom: 1px solid var(--pf-global--BorderColor--100);
                margin-bottom: 2rem;
                box-shadow: var(--pf-global--box-shadow);
            }
            
            .tab {
                padding: 1rem 1.5rem;
                border-bottom: 3px solid transparent;
                cursor: pointer;
                color: var(--pf-global--Color--200);
                text-decoration: none;
                font-weight: 500;
                transition: all 0.2s ease;
            }
            
            .tab.active {
                border-bottom-color: var(--pf-global--primary-color--100);
                color: var(--pf-global--primary-color--100);
            }
            
            .tab:hover {
                background-color: var(--pf-global--BackgroundColor--200);
                color: var(--pf-global--Color--100);
            }
            
            .card {
                background-color: var(--pf-global--BackgroundColor--100);
                border: 1px solid var(--pf-global--BorderColor--100);
                border-radius: 4px;
                margin-bottom: 1.5rem;
                box-shadow: var(--pf-global--box-shadow);
            }
            
            .card-header {
                padding: 1.5rem;
                border-bottom: 1px solid var(--pf-global--BorderColor--100);
                background-color: var(--pf-global--BackgroundColor--100);
            }
            
            .card-title {
                color: var(--pf-global--Color--100);
                font-size: 1.25rem;
                font-weight: 500;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .alert {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 4px;
                border-left: 4px solid;
                font-size: 14px;
            }
            
            .alert-info {
                background-color: #e6f7ff;
                border-left-color: var(--pf-global--primary-color--100);
                color: var(--pf-global--primary-color--200);
            }
            
            .alert-success {
                background-color: #f6ffed;
                border-left-color: var(--pf-global--success-color--100);
                color: var(--pf-global--success-color--200);
            }
            
            .alert-warning {
                background-color: #fffbe6;
                border-left-color: var(--pf-global--warning-color--100);
                color: #ad6800;
            }
            
            .alert-danger {
                background-color: #fff2f0;
                border-left-color: var(--pf-global--danger-color--100);
                color: var(--pf-global--danger-color--200);
            }
            
            .status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
            
            .status-card {
                background-color: var(--pf-global--BackgroundColor--100);
                border: 1px solid var(--pf-global--BorderColor--100);
                border-radius: 4px;
                padding: 1.5rem;
                text-align: center;
                box-shadow: var(--pf-global--box-shadow);
                transition: all 0.2s ease;
            }
            
            .status-card:hover {
                box-shadow: 0 0.5rem 1rem 0rem rgba(3, 3, 4, 0.16), 0 0 0.375rem 0rem rgba(3, 3, 4, 0.08);
            }
            
            .status-card h3 {
                margin: 0 0 0.5rem 0;
                color: var(--pf-global--Color--200);
                font-size: 14px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            .status-number {
                font-size: 2.5rem;
                font-weight: 700;
                margin: 0.5rem 0;
                line-height: 1;
            }
            
            .status-number.success { color: var(--pf-global--success-color--100); }
            .status-number.warning { color: var(--pf-global--warning-color--100); }
            .status-number.danger { color: var(--pf-global--danger-color--100); }
            .status-number.primary { color: var(--pf-global--primary-color--100); }
            
            .status-description {
                color: var(--pf-global--Color--200);
                font-size: 12px;
                margin: 0;
            }
            
            .table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
                background-color: var(--pf-global--BackgroundColor--100);
            }
            
            .table th {
                background-color: var(--pf-global--BackgroundColor--200);
                color: var(--pf-global--Color--100);
                padding: 0.75rem;
                text-align: left;
                font-weight: 600;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                border-bottom: 2px solid var(--pf-global--BorderColor--100);
            }
            
            .table td {
                padding: 0.75rem;
                border-bottom: 1px solid var(--pf-global--BorderColor--100);
                color: var(--pf-global--Color--100);
                font-size: 14px;
                vertical-align: middle;
            }
            
            .table tr:hover {
                background-color: var(--pf-global--BackgroundColor--200);
            }
            
            .badge {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.5rem;
                border-radius: 3px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                gap: 0.25rem;
            }
            
            .badge-success {
                background-color: #f6ffed;
                color: var(--pf-global--success-color--100);
                border: 1px solid #b7eb8f;
            }
            
            .badge-warning {
                background-color: #fffbe6;
                color: #ad6800;
                border: 1px solid #ffe58f;
            }
            
            .badge-danger {
                background-color: #fff2f0;
                color: var(--pf-global--danger-color--100);
                border: 1px solid #ffccc7;
            }
            
            .badge-info {
                background-color: #e6f7ff;
                color: var(--pf-global--primary-color--100);
                border: 1px solid #91d5ff;
            }
            
            .link {
                color: var(--pf-global--primary-color--100);
                text-decoration: none;
                font-weight: 500;
            }
            
            .link:hover {
                color: var(--pf-global--primary-color--200);
                text-decoration: underline;
            }
            
            .metadata-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-bottom: 2rem;
            }
            
            .metadata-item {
                background-color: var(--pf-global--BackgroundColor--100);
                border: 1px solid var(--pf-global--BorderColor--100);
                padding: 1rem;
                border-radius: 4px;
            }
            
            .metadata-label {
                color: var(--pf-global--Color--200);
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                margin-bottom: 0.25rem;
            }
            
            .metadata-value {
                color: var(--pf-global--Color--100);
                font-size: 14px;
                word-break: break-word;
            }
            
            .footer {
                margin-top: 3rem;
                padding: 2rem;
                background-color: var(--pf-global--BackgroundColor--100);
                border-top: 1px solid var(--pf-global--BorderColor--100);
                text-align: center;
                color: var(--pf-global--Color--200);
                font-size: 12px;
            }
            
            @media (max-width: 768px) {
                .container {
                    padding: 0 1rem 1rem;
                }
                .page-header {
                    padding: 1rem;
                }
                .status-grid {
                    grid-template-columns: 1fr;
                }
                .tabs {
                    flex-direction: column;
                }
            }
        </style>
        <script>
            // Auto-refresh every 20 minutes
            setTimeout(function() {
                console.log('Auto-refreshing certificate status...');
                window.location.reload();
            }, 1200000);
        </script>
    </head>
    <body>
        <div class="breadcrumb">
            <a href="index.html">Home</a> / <a href="certs.html">Certificate Monitor</a> / Overview
        </div>
        
        <div class="page-header">
            <h1 class="page-title">
                üîê OpenShift Certificate Monitor
            </h1>
            <p class="page-subtitle">Real-time certificate status with rotation at 80% of certificate lifespan</p>
        </div>

        <div class="container">
            <div class="tabs">
                <a href="index.html" class="tab">Overview</a>
                <a href="certs.html" class="tab active">Certificates</a>
            </div>

            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Rotation Logic:</strong> OpenShift rotates certificates at 80% of their total lifespan (from creation to expiry). Generated: $GENERATED_TIME
            </div>

            <div class="metadata-grid">
                <div class="metadata-item">
                    <div class="metadata-label">Cluster</div>
                    <div class="metadata-value">$CLUSTER_NAME</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">User</div>
                    <div class="metadata-value">$USER_NAME</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Last Updated</div>
                    <div class="metadata-value">$GENERATED_TIME</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Rotation Logic</div>
                    <div class="metadata-value">80% of certificate lifespan</div>
                </div>
            </div>
    EOF

        # Get certificate summary
        get_certificate_summary

        # Add rotation explanation
        cat >> "$OUTPUT_FILE" << EOF
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Certificate Rotation Logic</h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>How Rotation Works:</strong> OpenShift automatically rotates certificates at 80% of their total lifespan. 
                        This is calculated from the certificate's creation date (Not Before) to its expiry date (Not After).
                    </div>
                    
                    <div class="card" style="margin: 1rem 0;">
                        <div style="padding: 1rem;">
                            <h4>Example Calculation:</h4>
                            <ul style="margin: 0.5rem 0;">
                                <li><strong>Certificate Created:</strong> January 1, 2024</li>
                                <li><strong>Certificate Expires:</strong> January 1, 2026 (2 years = 730 days lifespan)</li>
                                <li><strong>Rotation Time:</strong> 80% of 730 days = 584 days after creation</li>
                                <li><strong>Rotation Date:</strong> August 9, 2025 (584 days after January 1, 2024)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
    EOF

        # Check important certificate namespaces
        check_namespace_certs "openshift-service-ca" "Service CA Certificates"
        check_namespace_certs "openshift-ingress" "Ingress Router Certificates"
        check_namespace_certs "openshift-monitoring" "Monitoring & Metrics Certificates"
        check_namespace_certs "openshift-console" "Console Certificates"
        check_namespace_certs "openshift-ovn-kubernetes" "Network Certificates"
        check_namespace_certs "openshift-machine-config-operator" "Machine Config Certificates"

        # Add rotation alerts
        get_rotation_alerts

        # Add footer
        cat >> "$OUTPUT_FILE" << EOF
            <div class="footer">
                <p>OpenShift Certificate Monitor | Auto-refresh every 20 minutes | 
                Rotation calculated at 80% of certificate lifespan</p>
            </div>
        </div>
    </body>
    </html>
    EOF
    }

    # Function to get certificate summary
    get_certificate_summary() {
        local cert_count=$(oc get secrets --all-namespaces --field-selector type=kubernetes.io/tls --no-headers 2>/dev/null | wc -l | tr -d ' ')
        local rotation_count=0
        local overdue_count=0
        
        # Count certificates needing rotation soon
        local current_epoch=$(date +%s)
        
        cat >> "$OUTPUT_FILE" << EOF
            <div class="status-grid">
                <div class="status-card">
                    <h3>Total Certificates</h3>
                    <div class="status-number primary">$cert_count</div>
                    <p class="status-description">TLS Secrets Monitored</p>
                </div>
                <div class="status-card">
                    <h3>Rotation Logic</h3>
                    <div class="status-number success">80%</div>
                    <p class="status-description">Of certificate lifespan</p>
                </div>
                <div class="status-card">
                    <h3>Monitoring</h3>
                    <div class="status-number primary">Real-time</div>
                    <p class="status-description">Certificate status tracking</p>
                </div>
                <div class="status-card">
                    <h3>Auto Refresh</h3>
                    <div class="status-number success">20min</div>
                    <p class="status-description">Update interval</p>
                </div>
            </div>
    EOF
    }

    # Function to check for upcoming rotations
    get_rotation_alerts() {
        cat >> "$OUTPUT_FILE" << EOF
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚ö†Ô∏è Upcoming Certificate Rotations (Next 30 Days)</h2>
                </div>
                <div class="card-body">
    EOF

        local found_upcoming=false
        local current_epoch=$(date +%s)

        # Check each namespace for upcoming rotations
        for namespace in openshift-service-ca openshift-ingress openshift-monitoring openshift-console openshift-ovn-kubernetes openshift-machine-config-operator; do
            if oc get namespace "$namespace" >/dev/null 2>&1; then
                oc -n $namespace get secrets --no-headers -o custom-columns="NAME:.metadata.name,TYPE:.type" 2>/dev/null | grep kubernetes.io/tls | head -5 | while read name type; do
                    # Get certificate data
                    cert_data=$(oc -n $namespace get secret $name -o go-template='{{index .data "tls.crt"}}' 2>/dev/null)
                    
                    if [ -n "$cert_data" ]; then
                        cert_decoded=$(echo "$cert_data" | base64 -d 2>/dev/null)
                        
                        if [ -n "$cert_decoded" ]; then
                            not_before=$(echo "$cert_decoded" | openssl x509 -noout -startdate 2>/dev/null | cut -d= -f2)
                            not_after=$(echo "$cert_decoded" | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
                            
                            if [ -n "$not_before" ] && [ -n "$not_after" ]; then
                                before_epoch=$(date -d "$not_before" +%s 2>/dev/null)
                                after_epoch=$(date -d "$not_after" +%s 2>/dev/null)
                                
                                if [ -n "$before_epoch" ] && [ -n "$after_epoch" ]; then
                                    # Calculate 80% rotation point
                                    total_lifespan=$((after_epoch - before_epoch))
                                    rotation_lifespan=$((total_lifespan * 80 / 100))
                                    rotation_epoch=$((before_epoch + rotation_lifespan))
                                    
                                    days_until_rotation=$(( (rotation_epoch - current_epoch) / 86400 ))
                                    
                                    if [ $days_until_rotation -le 30 ] && [ $days_until_rotation -gt 0 ]; then
                                        found_upcoming=true
                                        rotation_date=$(date -d "@$rotation_epoch" "+%m/%d/%Y")
                                        
                                        cat >> "$OUTPUT_FILE" << EOF
                                <div class="alert alert-warning">
                                    <strong>$namespace/$name</strong> - Rotation due: $rotation_date (~$days_until_rotation days)
                                    <br><small>At 80% of certificate lifespan</small>
                                </div>
    EOF
                                    elif [ $days_until_rotation -le 0 ]; then
                                        found_upcoming=true
                                        cat >> "$OUTPUT_FILE" << EOF
                                <div class="alert alert-danger">
                                    <strong>$namespace/$name</strong> - Rotation overdue by $((-days_until_rotation)) days
                                    <br><small>Should have rotated at 80% of lifespan</small>
                                </div>
    EOF
                                    fi
                                fi
                            fi
                        fi
                    fi
                done
            fi
        done

        if [ "$found_upcoming" = false ]; then
            cat >> "$OUTPUT_FILE" << EOF
                    <div class="alert alert-success">
                        <strong>‚úÖ No certificates scheduled to rotate in the next 30 days</strong> based on 80% lifespan calculation
                    </div>
    EOF
        fi

        cat >> "$OUTPUT_FILE" << EOF
                </div>
            </div>
    EOF
    }

    # Function to check certificates in a namespace
    check_namespace_certs() {
        local namespace=$1
        local title=$2

        cat >> "$OUTPUT_FILE" << EOF
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîê $title</h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>Rotation at 80% of certificate lifespan</strong> - calculated from creation to expiry date
                    </div>
    EOF

        # Check if namespace exists
        if ! oc get namespace "$namespace" >/dev/null 2>&1; then
            cat >> "$OUTPUT_FILE" << EOF
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Namespace $namespace not found</strong>
                    </div>
                </div>
            </div>
    EOF
            return
        fi

        cat >> "$OUTPUT_FILE" << EOF
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Certificate Name</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Lifespan</th>
                                <th>Rotation Time (80%)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
    EOF

        local cert_found=false
        local current_epoch=$(date +%s)
        
        # Get TLS secrets in this namespace
        oc -n $namespace get secrets --no-headers -o custom-columns="NAME:.metadata.name,TYPE:.type" 2>/dev/null | grep kubernetes.io/tls | head -10 | while read name type; do
            cert_found=true
            
            # Get the certificate data and parse it
            cert_data=$(oc -n $namespace get secret $name -o go-template='{{index .data "tls.crt"}}' 2>/dev/null)
            
            if [ -n "$cert_data" ]; then
                cert_decoded=$(echo "$cert_data" | base64 -d 2>/dev/null)
                
                if [ -n "$cert_decoded" ]; then
                    not_before=$(echo "$cert_decoded" | openssl x509 -noout -startdate 2>/dev/null | cut -d= -f2)
                    not_after=$(echo "$cert_decoded" | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
                    subject=$(echo "$cert_decoded" | openssl x509 -noout -subject 2>/dev/null | cut -d= -f2- | sed 's/^subject=//')
                    
                    if [ -n "$not_before" ] && [ -n "$not_after" ]; then
                        # Parse dates
                        before_epoch=$(date -d "$not_before" +%s 2>/dev/null)
                        after_epoch=$(date -d "$not_after" +%s 2>/dev/null)
                        
                        if [ -n "$before_epoch" ] && [ -n "$after_epoch" ]; then
                            # Calculate lifespan and rotation
                            total_lifespan=$((after_epoch - before_epoch))
                            lifespan_days=$((total_lifespan / 86400))
                            
                            rotation_lifespan=$((total_lifespan * 80 / 100))
                            rotation_epoch=$((before_epoch + rotation_lifespan))
                            
                            # Format dates
                            created_date=$(date -d "$not_before" "+%m/%d/%Y" 2>/dev/null)
                            expiry_date=$(date -d "$not_after" "+%m/%d/%Y" 2>/dev/null)
                            rotation_date=$(date -d "@$rotation_epoch" "+%m/%d/%Y" 2>/dev/null)
                            
                            # Calculate status
                            days_until_rotation=$(( (rotation_epoch - current_epoch) / 86400 ))
                            days_until_expiry=$(( (after_epoch - current_epoch) / 86400 ))
                            
                            # Determine status badge
                            local status_badge=""
                            if [ $rotation_epoch -le $current_epoch ]; then
                                status_badge="<span class=\"badge badge-danger\">üî¥ Rotation overdue</span>"
                            elif [ $days_until_rotation -le 30 ]; then
                                status_badge="<span class=\"badge badge-warning\">üü° ${days_until_rotation}d to rotation</span>"
                            else
                                status_badge="<span class=\"badge badge-success\">üü¢ ${days_until_rotation}d to rotation</span>"
                            fi
                            
                            cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td><strong>$name</strong></td>
                                <td>$created_date</td>
                                <td>$expiry_date<br><small>($days_until_expiry days)</small></td>
                                <td>${lifespan_days} days</td>
                                <td>$rotation_date<br><small>($days_until_rotation days)</small></td>
                                <td>$status_badge</td>
                            </tr>
    EOF
                        else
                            cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td><strong>$name</strong></td>
                                <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è Date parse error</span></td>
                            </tr>
    EOF
                        fi
                    else
                        cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td><strong>$name</strong></td>
                                <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è Certificate parse error</span></td>
                            </tr>
    EOF
                    fi
                else
                    cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td><strong>$name</strong></td>
                                <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è Base64 decode error</span></td>
                            </tr>
    EOF
                fi
            else
                cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td><strong>$name</strong></td>
                                <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è No certificate data</span></td>
                            </tr>
    EOF
            fi
        done

        if [ "$cert_found" = false ]; then
            cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td colspan="6" style="text-align: center; color: #ad6800;">
                                    <span class="badge badge-warning">‚ö†Ô∏è No TLS certificates found in this namespace</span>
                                </td>
                            </tr>
    EOF
        fi

        cat >> "$OUTPUT_FILE" << EOF
                        </tbody>
                    </table>
                </div>
            </div>
    EOF
    }

    # Main execution
    echo "üöÄ Starting certificate analysis with corrected rotation logic..."
    echo "‚úÖ Using 80% of certificate lifespan for rotation calculation"
    
    # Generate the HTML output
    generate_html_output
    
    echo "‚úÖ Certificate status HTML generated at: $OUTPUT_FILE"
    echo "üîÑ Rotation calculated at 80% of each certificate's actual lifespan"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cert-status-app
  namespace: cert-status-app
  labels:
    app: cert-status-monitor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cert-status-monitor
  template:
    metadata:
      labels:
        app: cert-status-monitor
        rotation-logic: "80-percent-lifespan"
    spec:
      serviceAccountName: cert-monitor-sa
      securityContext:
        runAsNonRoot: true
      initContainers:
      - name: content-setup
        image: registry.redhat.io/ubi9/ubi:latest
        command:
        - /bin/bash
        - -c
        - |
          echo "üöÄ Setting up corrected certificate monitoring website..."
          cd /var/www/html
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>OpenShift Certificate Monitor</title>
              <meta http-equiv="refresh" content="1200">
              <style>
                  :root {
                      --pf-global--Color--100: #151515;
                      --pf-global--Color--200: #6a6e73;
                      --pf-global--primary-color--100: #0066cc;
                      --pf-global--success-color--100: #3e8635;
                      --pf-global--BackgroundColor--100: #ffffff;
                      --pf-global--BackgroundColor--200: #f5f5f5;
                      --pf-global--BorderColor--100: #d2d2d2;
                      --pf-global--box-shadow: 0 0.25rem 0.5rem 0rem rgba(3, 3, 4, 0.12);
                  }
                  
                  body {
                      font-family: "RedHatText", "Overpass", overpass, helvetica, arial, sans-serif;
                      margin: 0;
                      padding: 0;
                      background-color: var(--pf-global--BackgroundColor--200);
                      color: var(--pf-global--Color--100);
                      line-height: 1.5;
                  }
                  
                  .page-header {
                      background-color: var(--pf-global--BackgroundColor--100);
                      border-bottom: 1px solid var(--pf-global--BorderColor--100);
                      padding: 2rem;
                      margin-bottom: 2rem;
                      box-shadow: var(--pf-global--box-shadow);
                  }
                  
                  .page-title {
                      color: var(--pf-global--Color--100);
                      font-size: 2.5rem;
                      font-weight: 500;
                      margin: 0;
                  }
                  
                  .page-subtitle {
                      color: var(--pf-global--Color--200);
                      font-size: 1.1rem;
                      margin: 0.5rem 0 0 0;
                  }
                  
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 0 2rem;
                  }
                  
                  .tabs {
                      display: flex;
                      background-color: var(--pf-global--BackgroundColor--100);
                      border-bottom: 1px solid var(--pf-global--BorderColor--100);
                      margin-bottom: 2rem;
                      box-shadow: var(--pf-global--box-shadow);
                  }
                  
                  .tab {
                      padding: 1rem 1.5rem;
                      border-bottom: 3px solid transparent;
                      cursor: pointer;
                      color: var(--pf-global--Color--200);
                      text-decoration: none;
                      font-weight: 500;
                  }
                  
                  .tab.active {
                      border-bottom-color: var(--pf-global--primary-color--100);
                      color: var(--pf-global--primary-color--100);
                  }
                  
                  .card {
                      background-color: var(--pf-global--BackgroundColor--100);
                      border: 1px solid var(--pf-global--BorderColor--100);
                      border-radius: 4px;
                      margin-bottom: 2rem;
                      box-shadow: var(--pf-global--box-shadow);
                      padding: 2rem;
                  }
                  
                  .feature-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 2rem;
                      margin: 2rem 0;
                  }
                  
                  .feature-card {
                      background-color: var(--pf-global--BackgroundColor--100);
                      border: 1px solid var(--pf-global--BorderColor--100);
                      border-radius: 4px;
                      padding: 1.5rem;
                      box-shadow: var(--pf-global--box-shadow);
                  }
                  
                  .feature-card h3 {
                      color: var(--pf-global--primary-color--100);
                      margin-top: 0;
                  }
                  
                  .rotation-badge {
                      display: inline-flex;
                      align-items: center;
                      background-color: #f6ffed;
                      color: var(--pf-global--success-color--100);
                      padding: 0.5rem 1rem;
                      border-radius: 4px;
                      font-weight: 600;
                      gap: 0.5rem;
                      border: 1px solid #b7eb8f;
                  }
                  
                  .link {
                      color: var(--pf-global--primary-color--100);
                      text-decoration: none;
                      font-weight: 500;
                  }
                  
                  .link:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <div class="page-header">
                  <h1 class="page-title">üîê OpenShift Certificate Monitor</h1>
                  <p class="page-subtitle">Certificate monitoring with rotation at 80% of lifespan</p>
              </div>

              <div class="container">
                  <div class="tabs">
                      <a href="index.html" class="tab active">Overview</a>
                      <a href="certs.html" class="tab">Certificates</a>
                  </div>

                  <div class="card">
                      <h2>Welcome to the OpenShift Certificate Monitor</h2>
                      <p>This monitoring tool provides real-time visibility into OpenShift platform certificate status and rotation schedules. Certificates are automatically rotated at 80% of their lifespan.</p>
                      <p><span class="rotation-badge">üîÑ Rotation at 80% of certificate lifespan</span></p>
                  </div>

                  <div class="feature-grid">
                      <div class="feature-card">
                          <h3>üîÑ Corrected Rotation Logic</h3>
                          <p>Certificates are rotated at <strong>80% of their total lifespan</strong>, calculated from creation date to expiry date.</p>
                          <p>No more source code assumptions - uses actual certificate data.</p>
                      </div>

                      <div class="feature-card">
                          <h3>üìÖ Real Expiry Dates</h3>
                          <p>Shows actual certificate creation and expiry dates from the certificate itself, not estimated values.</p>
                          <p>Accurate lifespan calculation for precise rotation timing.</p>
                      </div>

                      <div class="feature-card">
                          <h3>üìä Live Monitoring</h3>
                          <p>Real-time certificate status tracking with automatic rotation predictions based on actual certificate data.</p>
                          <p><strong>Auto-refresh every 20 minutes</strong> for current status.</p>
                      </div>

                      <div class="feature-card">
                          <h3>üé® OpenShift Design</h3>
                          <p>Clean interface inspired by the OpenShift console design language for a familiar enterprise experience.</p>
                          <p>Responsive design works on all devices.</p>
                      </div>
                  </div>

                  <div class="card">
                      <h3>üöÄ Get Started</h3>
                      <p>Click <strong><a href="certs.html" class="link">Certificates</a></strong> above to view the live certificate status with actual rotation times calculated at 80% of certificate lifespan.</p>
                      <p>Each certificate shows creation date, expiry date, total lifespan, and calculated rotation time.</p>
                  </div>
              </div>
          </body>
          </html>
          EOF
          echo "‚úÖ Corrected certificate monitor website content created!"
          ls -la /var/www/html/
          echo "üéâ Init container completed - corrected rotation logic ready!"
        volumeMounts:
        - name: website-content
          mountPath: /var/www/html
        - name: cert-checker-script
          mountPath: /scripts
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
      containers:
      - name: httpd
        image: registry.redhat.io/ubi9/httpd-24:latest
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: website-content
          mountPath: /var/www/html
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
      - name: cert-updater
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          while true; do
            echo "üîÑ Updating certificate status with corrected rotation logic..."
            /scripts/check-certs.sh
            echo "‚úÖ Certificate status updated at $(date)"
            sleep 900  # Update every 15 minutes
          done
        volumeMounts:
        - name: website-content
          mountPath: /var/www/html
        - name: cert-checker-script
          mountPath: /scripts
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
      volumes:
      - name: website-content
        persistentVolumeClaim:
          claimName: cert-app-content-pvc
      - name: cert-checker-script
        configMap:
          name: cert-checker-script-corrected
          defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: cert-status-service
  namespace: cert-status-app
spec:
  selector:
    app: cert-status-monitor
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: ClusterIP
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: cert-status-route
  namespace: cert-status-app
spec:
  to:
    kind: Service
    name: cert-status-service
    weight: 100
  port:
    targetPort: 8080
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
  wildcardPolicy: None 