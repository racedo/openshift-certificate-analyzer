---
apiVersion: v1
kind: Namespace
metadata:
  name: cert-status-app
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cert-app-content-pvc
  namespace: cert-status-app
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: kubevirt-csi-infra-default
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-monitor-sa
  namespace: cert-status-app
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-monitor-role
rules:
- apiGroups: [""]
  resources: ["secrets", "namespaces"]
  verbs: ["get", "list"]
- apiGroups: ["certificates.k8s.io"]
  resources: ["certificatesigningrequests"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-monitor-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-monitor-role
subjects:
- kind: ServiceAccount
  name: cert-monitor-sa
  namespace: cert-status-app
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cert-checker-working-80-percent
  namespace: cert-status-app
data:
  check-certs.sh: |
    #!/bin/bash
    # OpenShift Certificate Monitor - Working 80% Rotation Logic
    # Certificates are rotated at 80% of their actual lifespan based on expiry date
    
    OUTPUT_FILE="/var/www/html/certs.html"
    
    echo "üöÄ Starting certificate analysis with working 80% rotation logic..."
    
    # Function to calculate rotation time at 80% of certificate lifespan
    calculate_rotation_at_80_percent() {
        local not_before="$1"
        local not_after="$2"
        
        if [ -z "$not_before" ] || [ -z "$not_after" ]; then
            echo "Unknown"
            return
        fi
        
        # Convert dates to epoch
        local before_epoch=$(date -d "$not_before" +%s 2>/dev/null)
        local after_epoch=$(date -d "$not_after" +%s 2>/dev/null)
        local current_epoch=$(date +%s)
        
        if [ -z "$before_epoch" ] || [ -z "$after_epoch" ]; then
            echo "Parse error"
            return
        fi
        
        # Calculate total certificate lifespan in seconds
        local total_lifespan=$((after_epoch - before_epoch))
        
        # Calculate 80% of lifespan
        local rotation_lifespan=$((total_lifespan * 80 / 100))
        
        # Calculate rotation time (creation + 80% of lifespan)
        local rotation_epoch=$((before_epoch + rotation_lifespan))
        
        # Calculate days until rotation
        local days_until_rotation=$(( (rotation_epoch - current_epoch) / 86400 ))
        
        # If rotation time has passed, certificate should have been rotated already
        if [ $rotation_epoch -le $current_epoch ]; then
            echo "Overdue by $(( (current_epoch - rotation_epoch) / 86400 )) days"
        else
            local rotation_date=$(date -d "@$rotation_epoch" "+%m/%d/%Y")
            echo "$rotation_date (~${days_until_rotation} days)"
        fi
    }

    # Function to generate HTML header
    generate_html_header() {
        local generated_time=$(date)
        local cluster_name=$(oc whoami --show-server 2>/dev/null | sed 's/https:\/\///' | cut -d':' -f1 2>/dev/null || echo 'my-hosted-cluster')
        local user_name=$(oc whoami 2>/dev/null || echo 'system:serviceaccount')
        
        cat > "$OUTPUT_FILE" << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenShift Certificate Monitor - 80% Rotation</title>
    <meta http-equiv="refresh" content="1200">
    <style>
        /* OpenShift Console-inspired design */
        :root {
            --pf-global--Color--100: #151515;
            --pf-global--Color--200: #6a6e73;
            --pf-global--primary-color--100: #0066cc;
            --pf-global--success-color--100: #3e8635;
            --pf-global--warning-color--100: #f0ab00;
            --pf-global--danger-color--100: #c9190b;
            --pf-global--BackgroundColor--100: #ffffff;
            --pf-global--BackgroundColor--200: #f5f5f5;
            --pf-global--BorderColor--100: #d2d2d2;
            --pf-global--box-shadow: 0 0.25rem 0.5rem 0rem rgba(3, 3, 4, 0.12);
        }
        
        body {
            font-family: "RedHatText", "Overpass", overpass, helvetica, arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--pf-global--BackgroundColor--200);
            color: var(--pf-global--Color--100);
            line-height: 1.5;
            font-size: 14px;
        }
        
        .page-header {
            background-color: var(--pf-global--BackgroundColor--100);
            border-bottom: 1px solid var(--pf-global--BorderColor--100);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--pf-global--box-shadow);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .card {
            background-color: var(--pf-global--BackgroundColor--100);
            border: 1px solid var(--pf-global--BorderColor--100);
            border-radius: 4px;
            margin-bottom: 2rem;
            box-shadow: var(--pf-global--box-shadow);
            padding: 2rem;
        }
        
        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            border-left: 4px solid;
            font-size: 14px;
        }
        
        .alert-success {
            background-color: #f6ffed;
            border-left-color: var(--pf-global--success-color--100);
            color: #2d5016;
        }
        
        .alert-info {
            background-color: #e6f7ff;
            border-left-color: var(--pf-global--primary-color--100);
            color: #004080;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            gap: 0.25rem;
        }
        
        .badge-success {
            background-color: #f6ffed;
            color: var(--pf-global--success-color--100);
            border: 1px solid #b7eb8f;
        }
        
        .badge-warning {
            background-color: #fffbe6;
            color: #ad6800;
            border: 1px solid #ffe58f;
        }
        
        .badge-danger {
            background-color: #fff2f0;
            color: var(--pf-global--danger-color--100);
            border: 1px solid #ffccc7;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--pf-global--BackgroundColor--100);
        }
        
        .table th {
            background-color: var(--pf-global--BackgroundColor--200);
            color: var(--pf-global--Color--100);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--pf-global--BorderColor--100);
        }
        
        .table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--pf-global--BorderColor--100);
            color: var(--pf-global--Color--100);
            font-size: 14px;
        }
        
        .table tr:hover {
            background-color: var(--pf-global--BackgroundColor--200);
        }
        
        h1 { color: var(--pf-global--Color--100); margin: 0; font-size: 2.5rem; font-weight: 500; }
        h2 { color: var(--pf-global--primary-color--100); margin-top: 0; }
    </style>
</head>
<body>
    <div class="page-header">
        <h1>üîê OpenShift Certificate Monitor</h1>
        <p style="color: var(--pf-global--Color--200); font-size: 1.1rem; margin: 0.5rem 0 0 0;">
            Certificate rotation at 80% of lifespan - Working Implementation
        </p>
    </div>

    <div class="container">
        <div class="alert alert-success">
            <strong>‚úÖ WORKING 80% ROTATION LOGIC:</strong> Certificates are rotated at <strong>80% of their total lifespan</strong>. 
            This is calculated from the certificate's actual creation date to its expiry date.
        </div>

        <div class="alert alert-info">
            <strong>üìä Cluster:</strong> $cluster_name | <strong>User:</strong> $user_name | <strong>Generated:</strong> $generated_time
        </div>
EOF
    }

    # Function to check certificates in a namespace and add to HTML
    check_namespace_certs() {
        local namespace=$1
        local title=$2

        cat >> "$OUTPUT_FILE" << EOF
        <div class="card">
            <h2>üîê $title</h2>
            <div class="alert alert-info">
                <strong>Namespace:</strong> $namespace | <strong>Rotation:</strong> 80% of certificate lifespan
            </div>
EOF

        # Check if namespace exists
        if ! oc get namespace "$namespace" >/dev/null 2>&1; then
            cat >> "$OUTPUT_FILE" << EOF
            <div class="alert alert-warning" style="background-color: #fffbe6; border-left-color: var(--pf-global--warning-color--100); color: #ad6800;">
                <strong>‚ö†Ô∏è Namespace $namespace not found</strong>
            </div>
        </div>
EOF
            return
        fi

        cat >> "$OUTPUT_FILE" << EOF
            <table class="table">
                <thead>
                    <tr>
                        <th>Certificate Name</th>
                        <th>Created</th>
                        <th>Expires</th>
                        <th>Lifespan (Days)</th>
                        <th>Rotation Time (80%)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
EOF

        local cert_found=false
        local current_epoch=$(date +%s)
        
        # Get TLS secrets in this namespace
        oc -n $namespace get secrets --no-headers -o custom-columns="NAME:.metadata.name,TYPE:.type" 2>/dev/null | grep kubernetes.io/tls | head -10 | while IFS=' ' read -r name type; do
            cert_found=true
            
            # Get the certificate data and parse it
            cert_data=$(oc -n $namespace get secret $name -o go-template='{{index .data "tls.crt"}}' 2>/dev/null)
            
            if [ -n "$cert_data" ]; then
                cert_decoded=$(echo "$cert_data" | base64 -d 2>/dev/null)
                
                if [ -n "$cert_decoded" ]; then
                    not_before=$(echo "$cert_decoded" | openssl x509 -noout -startdate 2>/dev/null | cut -d= -f2)
                    not_after=$(echo "$cert_decoded" | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
                    
                    if [ -n "$not_before" ] && [ -n "$not_after" ]; then
                        # Parse dates
                        before_epoch=$(date -d "$not_before" +%s 2>/dev/null)
                        after_epoch=$(date -d "$not_after" +%s 2>/dev/null)
                        
                        if [ -n "$before_epoch" ] && [ -n "$after_epoch" ]; then
                            # Calculate lifespan and rotation
                            total_lifespan=$((after_epoch - before_epoch))
                            lifespan_days=$((total_lifespan / 86400))
                            
                            rotation_lifespan=$((total_lifespan * 80 / 100))
                            rotation_epoch=$((before_epoch + rotation_lifespan))
                            
                            # Format dates
                            created_date=$(date -d "$not_before" "+%m/%d/%Y" 2>/dev/null)
                            expiry_date=$(date -d "$not_after" "+%m/%d/%Y" 2>/dev/null)
                            
                            # Calculate status
                            days_until_rotation=$(( (rotation_epoch - current_epoch) / 86400 ))
                            days_until_expiry=$(( (after_epoch - current_epoch) / 86400 ))
                            
                            # Determine status badge and rotation text
                            local status_badge=""
                            local rotation_text=""
                            
                            if [ $rotation_epoch -le $current_epoch ]; then
                                overdue_days=$(( (current_epoch - rotation_epoch) / 86400 ))
                                status_badge="<span class=\"badge badge-danger\">üî¥ Overdue $overdue_days days</span>"
                                rotation_text="Should have rotated"
                            elif [ $days_until_rotation -le 30 ]; then
                                rotation_date=$(date -d "@$rotation_epoch" "+%m/%d/%Y")
                                status_badge="<span class=\"badge badge-warning\">üü° ${days_until_rotation}d to rotation</span>"
                                rotation_text="$rotation_date"
                            else
                                rotation_date=$(date -d "@$rotation_epoch" "+%m/%d/%Y")
                                status_badge="<span class=\"badge badge-success\">üü¢ ${days_until_rotation}d to rotation</span>"
                                rotation_text="$rotation_date"
                            fi
                            
                            cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td><strong>$name</strong></td>
                                <td>$created_date</td>
                                <td>$expiry_date<br><small>($days_until_expiry days left)</small></td>
                                <td>$lifespan_days</td>
                                <td>$rotation_text<br><small>($days_until_rotation days)</small></td>
                                <td>$status_badge</td>
                            </tr>
EOF
                        else
                            cat >> "$OUTPUT_FILE" << EOF
                            <tr>
                                <td><strong>$name</strong></td>
                                <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è Date parse error</span></td>
                            </tr>
EOF
                        fi
                    else
                        cat >> "$OUTPUT_FILE" << EOF
                        <tr>
                            <td><strong>$name</strong></td>
                            <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è Certificate parse error</span></td>
                        </tr>
EOF
                    fi
                else
                    cat >> "$OUTPUT_FILE" << EOF
                    <tr>
                        <td><strong>$name</strong></td>
                        <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è Base64 decode error</span></td>
                    </tr>
EOF
                fi
            else
                cat >> "$OUTPUT_FILE" << EOF
                <tr>
                    <td><strong>$name</strong></td>
                    <td colspan="5"><span class="badge badge-warning">‚ö†Ô∏è No certificate data</span></td>
                </tr>
EOF
            fi
        done

        # If no certificates found in the while loop, we need to add a row outside
        # Check if any TLS secrets exist
        cert_count=$(oc -n $namespace get secrets --no-headers -o custom-columns="NAME:.metadata.name,TYPE:.type" 2>/dev/null | grep -c kubernetes.io/tls || echo "0")
        
        if [ "$cert_count" = "0" ]; then
            cat >> "$OUTPUT_FILE" << EOF
                <tr>
                    <td colspan="6" style="text-align: center; color: #ad6800;">
                        <span class="badge badge-warning">‚ö†Ô∏è No TLS certificates found in this namespace</span>
                    </td>
                </tr>
EOF
        fi

        cat >> "$OUTPUT_FILE" << EOF
                </tbody>
            </table>
        </div>
EOF
    }

    # Function to generate HTML footer
    generate_html_footer() {
        cat >> "$OUTPUT_FILE" << EOF
        <div style="margin-top: 3rem; padding: 2rem; background-color: var(--pf-global--BackgroundColor--100); border-top: 1px solid var(--pf-global--BorderColor--100); text-align: center; color: var(--pf-global--Color--200); font-size: 12px;">
            <p>OpenShift Certificate Monitor | Auto-refresh every 20 minutes</p>
            <p><strong>Rotation Logic:</strong> 80% of certificate lifespan (creation to expiry)</p>
            <p><strong>No ValidityDuration assumptions</strong> - Uses actual certificate data</p>
        </div>
    </div>

    <script>
        // Auto-refresh every 20 minutes
        setTimeout(function() {
            window.location.reload();
        }, 1200000);
    </script>
</body>
</html>
EOF
    }

    # Main execution
    echo "üîÑ Generating HTML header..."
    generate_html_header

    echo "üîç Checking certificate namespaces..."
    # Check important certificate namespaces
    check_namespace_certs "openshift-service-ca" "Service CA Certificates"
    check_namespace_certs "openshift-ingress" "Ingress Router Certificates"
    check_namespace_certs "openshift-monitoring" "Monitoring & Metrics Certificates"
    check_namespace_certs "openshift-console" "Console Certificates"
    check_namespace_certs "openshift-ovn-kubernetes" "Network Certificates"
    check_namespace_certs "openshift-machine-config-operator" "Machine Config Certificates"

    echo "üîÑ Generating HTML footer..."
    generate_html_footer

    echo "‚úÖ Certificate status HTML generated with working 80% rotation logic at: $OUTPUT_FILE"
    echo "üîÑ Showing real certificate data with 80% rotation calculations"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cert-status-app
  namespace: cert-status-app
  labels:
    app: cert-status-monitor
    version: "working-80-percent"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cert-status-monitor
  template:
    metadata:
      labels:
        app: cert-status-monitor
        version: "working-80-percent"
    spec:
      serviceAccountName: cert-monitor-sa
      securityContext:
        runAsNonRoot: true
      initContainers:
      - name: content-setup
        image: registry.redhat.io/ubi9/ubi:latest
        command:
        - /bin/bash
        - -c
        - |
          echo "üöÄ Setting up working 80% rotation certificate monitoring..."
          cd /var/www/html
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>OpenShift Certificate Monitor - Working 80% Rotation</title>
              <style>
                  body {
                      font-family: "RedHatText", Arial, sans-serif;
                      margin: 0;
                      padding: 20px;
                      background-color: #f5f5f5;
                      color: #151515;
                  }
                  .header {
                      background: white;
                      padding: 30px;
                      border-radius: 8px;
                      margin-bottom: 20px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      text-align: center;
                  }
                  .card {
                      background: white;
                      padding: 20px;
                      border-radius: 8px;
                      margin-bottom: 20px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .badge {
                      background: #f6ffed;
                      color: #3e8635;
                      padding: 8px 16px;
                      border-radius: 4px;
                      font-weight: bold;
                      border: 1px solid #b7eb8f;
                  }
                  .link { color: #0066cc; text-decoration: none; font-weight: 500; }
                  .link:hover { text-decoration: underline; }
                  h1 { color: #151515; margin: 0; font-size: 2.5rem; }
                  h2 { color: #0066cc; margin-top: 0; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>üîê OpenShift Certificate Monitor</h1>
                  <p style="font-size: 1.2rem; color: #6a6e73; margin: 10px 0 0 0;">
                      Working 80% rotation logic with real certificate data
                  </p>
              </div>

              <div class="card">
                  <h2>‚úÖ WORKING: 80% Rotation Logic</h2>
                  <p>This monitoring tool now shows <strong>real certificate data</strong> with correct 80% rotation calculations:</p>
                  <ul>
                      <li><strong>‚úÖ Shows actual certificates from cluster</strong></li>
                      <li><strong>‚úÖ Calculates 80% of certificate lifespan</strong></li>
                      <li><strong>‚úÖ Real creation and expiry dates</strong></li>
                      <li><strong>‚ùå No ValidityDuration references</strong></li>
                  </ul>
                  <p><span class="badge">üîÑ 80% Rotation Logic Working</span></p>
              </div>

              <div class="card">
                  <h2>üìä View Live Certificates</h2>
                  <p>Click <strong><a href="certs.html" class="link">Certificates</a></strong> to view live certificate status with working 80% rotation calculations.</p>
                  <p>Now showing real certificate data from your OpenShift cluster!</p>
              </div>
          </body>
          </html>
          EOF
          echo "‚úÖ Working 80% rotation website content created!"
          ls -la /var/www/html/
        volumeMounts:
        - name: website-content
          mountPath: /var/www/html
        - name: cert-checker-script
          mountPath: /scripts
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
      containers:
      - name: httpd
        image: registry.redhat.io/ubi9/httpd-24:latest
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: website-content
          mountPath: /var/www/html
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
      - name: cert-updater
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          while true; do
            echo "üîÑ Updating certificate status with working 80% rotation logic..."
            /scripts/check-certs.sh
            echo "‚úÖ Certificate status updated with working 80% rotation logic at $(date)"
            sleep 900  # Update every 15 minutes
          done
        volumeMounts:
        - name: website-content
          mountPath: /var/www/html
        - name: cert-checker-script
          mountPath: /scripts
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
      volumes:
      - name: website-content
        persistentVolumeClaim:
          claimName: cert-app-content-pvc
      - name: cert-checker-script
        configMap:
          name: cert-checker-working-80-percent
          defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: cert-status-service
  namespace: cert-status-app
spec:
  selector:
    app: cert-status-monitor
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: ClusterIP
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: cert-status-route
  namespace: cert-status-app
spec:
  to:
    kind: Service
    name: cert-status-service
    weight: 100
  port:
    targetPort: 8080
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
  wildcardPolicy: None 